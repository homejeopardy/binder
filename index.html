<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Script Viewer</title>
  <style>
    html, body {
      margin: 0; padding: 0;
      background: #111; color: #fff;
      height: 100%; width: 100%;
      overflow: hidden; font-family: sans-serif;
    }
    body.night-mode {
      background: #eee; color: #111;
    }
    #toolbar {
      position: absolute; top: 10px; left: 10px; z-index: 100;
      background: rgba(0, 0, 0, 0.6);
      padding: 8px 12px; border-radius: 8px;
      display: flex; gap: 10px;
    }
    #pdf-container {
      display: flex; justify-content: center; align-items: center;
      height: 100%; gap: 2vw; position: relative;
    }
    canvas {
      max-height: 90vh; max-width: 45vw;
      background: white;
      box-shadow: 0 0 20px rgba(0,0,0,0.7);
      cursor: pointer;
    }
    .note {
      position: absolute;
      min-width: 120px; min-height: 80px;
      background: yellow; color: black;
      border: 1px solid #333;
      padding: 6px; border-radius: 8px;
      resize: both; overflow: auto;
      cursor: move; z-index: 10;
    }
    .note textarea {
      width: 100%; height: 50px; resize: none;
    }
    .arrow {
      position: absolute;
      height: 2px; background: red;
      transform-origin: left center;
      z-index: 5;
    }
    button {
      background: #444; border: none;
      color: white; padding: 5px 10px;
      border-radius: 6px; cursor: pointer;
    }
  </style>
</head>
<body>
  <div id="toolbar">
    <input type="file" id="fileInput" accept="application/pdf"/>
    <button id="fullscreenBtn">â›¶ Fullscreen</button>
    <button id="nightModeBtn">ðŸŒ™ Night Mode</button>
    <button id="bookmarkBtn">ðŸ”– Bookmark</button>
    <button id="addNoteBtn">âž• Add Note</button>
    <select id="sceneSelector">
      <option value="">Jump to Scene</option>
      <option value="1">Act 1, Scene 1</option>
      <option value="5">Act 1, Scene 2</option>
      <option value="11">Act 2, Scene 1</option>
    </select>
  </div>

  <div id="pdf-container">
    <canvas id="leftPage"></canvas>
    <canvas id="rightPage"></canvas>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <script>
    const container = document.getElementById('pdf-container');
    const fileInput = document.getElementById('fileInput');
    const fullscreenBtn = document.getElementById('fullscreenBtn');
    const nightModeBtn = document.getElementById('nightModeBtn');
    const bookmarkBtn = document.getElementById('bookmarkBtn');
    const addNoteBtn = document.getElementById('addNoteBtn');
    const sceneSelector = document.getElementById('sceneSelector');
    const leftCanvas = document.getElementById('leftPage');
    const rightCanvas = document.getElementById('rightPage');

    let pdfDoc = null;
    let currentPage = 1;
    let settingArrow = null;
    let notes = JSON.parse(localStorage.getItem("notes") || "{}");
    let bookmarks = JSON.parse(localStorage.getItem("bookmarks") || "[]");

    function saveNotes() {
      localStorage.setItem("notes", JSON.stringify(notes));
    }
    
    function saveBookmarks() {
      localStorage.setItem("bookmarks", JSON.stringify(bookmarks));
    }

    function updateArrow(note, arrow) {
      const dx = note.targetX - note.x;
      const dy = note.targetY - note.y;
      const len = Math.sqrt(dx * dx + dy * dy);
      const angle = Math.atan2(dy, dx) * 180 / Math.PI;
      arrow.style.left = note.x + "px";
      arrow.style.top = note.y + "px";
      arrow.style.width = len + "px";
      arrow.style.transform = `rotate(${angle}deg)`;
    }

    function renderNotesForPage(spread) {
      document.querySelectorAll(".note, .arrow").forEach(e => e.remove());
      if (!notes[spread]) return;

      notes[spread].forEach(note => {
        const noteEl = document.createElement("div");
        noteEl.className = "note";
        noteEl.style.left = note.x + "px";
        noteEl.style.top = note.y + "px";
        noteEl.innerHTML = `
          <textarea>${note.text}</textarea>
          <br>
          <button class="arrow-btn">ðŸ”½ Set Arrow Target</button>
        `;
        const arrow = document.createElement("div");
        arrow.className = "arrow";
        updateArrow(note, arrow);

        noteEl.querySelector("textarea").oninput = e => {
          note.text = e.target.value;
          saveNotes();
        };

        noteEl.querySelector(".arrow-btn").onclick = () => {
          settingArrow = note;
        };

        noteEl.onmousedown = e => {
          if (e.target.tagName === "TEXTAREA" || e.target.tagName === "BUTTON") return;
          const offsetX = e.clientX - noteEl.offsetLeft;
          const offsetY = e.clientY - noteEl.offsetTop;
          document.onmousemove = e => {
            note.x = e.clientX - offsetX;
            note.y = e.clientY - offsetY;
            noteEl.style.left = note.x + "px";
            noteEl.style.top = note.y + "px";
            updateArrow(note, arrow);
            saveNotes();
          };
          document.onmouseup = () => {
            document.onmousemove = null;
          };
        };

        container.appendChild(arrow);
        container.appendChild(noteEl);
      });
    }

    container.onclick = e => {
      if (settingArrow) {
        settingArrow.targetX = e.clientX;
        settingArrow.targetY = e.clientY;
        saveNotes();
        settingArrow = null;
        renderNotesForPage(currentPage);
      }
    };

    addNoteBtn.onclick = () => {
      if (!notes[currentPage]) notes[currentPage] = [];
      const note = { id: Date.now(), x: 150, y: 150, text: "New note", targetX: 250, targetY: 150 };
      notes[currentPage].push(note);
      saveNotes();
      renderNotesForPage(currentPage);
    };

    fullscreenBtn.onclick = () => {
      document.documentElement.requestFullscreen();
    };

    nightModeBtn.onclick = () => {
      document.body.classList.toggle("night-mode");
    };

    bookmarkBtn.onclick = () => {
      if (!bookmarks.includes(currentPage)) {
        bookmarks.push(currentPage);
        saveBookmarks();
        alert("Bookmarked page " + currentPage);
      }
    };

    sceneSelector.onchange = () => {
      const page = parseInt(sceneSelector.value);
      if (page) {
        currentPage = page;
        renderPagePair();
      }
    };

    async function renderPagePair() {
      if (!pdfDoc) return;
      await pdfDoc.getPage(currentPage).then(page => page.render({ canvasContext: leftCanvas.getContext("2d"), viewport: page.getViewport({ scale: 1.5 }) }).promise);
      await pdfDoc.getPage(currentPage + 1).then(page => page.render({ canvasContext: rightCanvas.getContext("2d"), viewport: page.getViewport({ scale: 1.5 }) }).promise);
      renderNotesForPage(currentPage);
    }

    fileInput.onchange = async e => {
      const reader = new FileReader();
      reader.onload = async () => { pdfDoc = await pdfjsLib.getDocument({ data: new Uint8Array(reader.result) }).promise; currentPage = 1; renderPagePair(); };
      reader.readAsArrayBuffer(e.target.files[0]);
    };
  </script>
</body>
</html>
