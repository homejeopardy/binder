<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Script Viewer</title>
  <style>
    html, body {
      margin: 0; padding: 0;
      background: #111; color: #fff;
      height: 100%; width: 100%;
      overflow: hidden; font-family: sans-serif;
    }
    #toolbar {
      position: absolute; top: 10px; left: 10px; z-index: 100;
      background: rgba(0, 0, 0, 0.6);
      padding: 8px 12px; border-radius: 8px;
      display: flex; gap: 10px;
    }
    #pdf-container {
      display: flex; justify-content: center; align-items: center;
      height: 100%; gap: 2vw; perspective: 2000px;
      position: relative;
    }
    canvas {
      max-height: 90vh; max-width: 45vw;
      background: white;
      box-shadow: 0 0 20px rgba(0,0,0,0.7);
      cursor: pointer;
    }
    .note {
      position: absolute;
      min-width: 120px; min-height: 80px;
      background: yellow; color: black;
      border: 1px solid #333;
      padding: 6px; border-radius: 8px;
      resize: both; overflow: auto;
      cursor: move; z-index: 10;
    }
    .note textarea {
      width: 100%; height: 50px; resize: none;
    }
    .arrow {
      position: absolute;
      height: 2px; background: red;
      transform-origin: left center;
      z-index: 5;
    }
    button {
      background: #444; border: none;
      color: white; padding: 5px 10px;
      border-radius: 6px; cursor: pointer;
    }
  </style>
</head>
<body>
  <div id="toolbar">
    <input type="file" id="fileInput" accept="application/pdf"/>
    <button id="addNoteBtn">âž• Add Note</button>
  </div>
  <div id="pdf-container">
    <canvas id="leftPage"></canvas>
    <canvas id="rightPage"></canvas>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <script>
    const container = document.getElementById('pdf-container');
    const fileInput = document.getElementById('fileInput');
    const leftCanvas = document.getElementById('leftPage');
    const rightCanvas = document.getElementById('rightPage');
    const addNoteBtn = document.getElementById('addNoteBtn');

    let currentPage = 1;
    let pdfDoc = null;
    let settingArrow = null;
    let notes = JSON.parse(localStorage.getItem("notes") || "{}");

    function saveNotes() {
      localStorage.setItem("notes", JSON.stringify(notes));
    }

    function updateArrow(note, arrow) {
      const dx = note.targetX - note.x;
      const dy = note.targetY - note.y;
      const len = Math.sqrt(dx * dx + dy * dy);
      const angle = Math.atan2(dy, dx) * 180 / Math.PI;
      arrow.style.left = note.x + "px";
      arrow.style.top = note.y + "px";
      arrow.style.width = len + "px";
      arrow.style.transform = `rotate(${angle}deg)`;
    }

    function renderNotesForPage(spread) {
      document.querySelectorAll(".note, .arrow").forEach(e => e.remove());
      if (!notes[spread]) return;

      notes[spread].forEach(note => {
        const noteEl = document.createElement("div");
        noteEl.className = "note";
        noteEl.style.left = note.x + "px";
        noteEl.style.top = note.y + "px";
        noteEl.innerHTML = `
          <textarea>${note.text}</textarea>
          <br>
          <button class="arrow-btn">ðŸ”½ Set Arrow Target</button>
        `;
        const arrow = document.createElement("div");
        arrow.className = "arrow";
        updateArrow(note, arrow);

        // Update text
        noteEl.querySelector("textarea").oninput = e => {
          note.text = e.target.value;
          saveNotes();
        };

        // Set arrow mode
        noteEl.querySelector(".arrow-btn").onclick = () => {
          settingArrow = note;
        };

        // Dragging
        noteEl.onmousedown = e => {
          if (e.target.tagName === "TEXTAREA" || e.target.tagName === "BUTTON") return;
          const offsetX = e.clientX - noteEl.offsetLeft;
          const offsetY = e.clientY - noteEl.offsetTop;
          document.onmousemove = e => {
            note.x = e.clientX - offsetX;
            note.y = e.clientY - offsetY;
            noteEl.style.left = note.x + "px";
            noteEl.style.top = note.y + "px";
            updateArrow(note, arrow);
            saveNotes();
          };
          document.onmouseup = () => {
            document.onmousemove = null;
          };
        };

        container.appendChild(arrow);
        container.appendChild(noteEl);
      });
    }

    container.onclick = e => {
      if (settingArrow) {
        settingArrow.targetX = e.clientX;
        settingArrow.targetY = e.clientY;
        saveNotes();
        settingArrow = null;
        renderNotesForPage(currentPage);
      }
    };

    addNoteBtn.onclick = () => {
      const spread = currentPage;
      if (!notes[spread]) notes[spread] = [];
      const note = {
        id: Date.now(),
        x: 150, y: 150,
        text: "New note",
        targetX: 250,
        targetY: 150
      };
      notes[spread].push(note);
      saveNotes();
      renderNotesForPage(spread);
    };

    async function renderPagePair() {
      if (!pdfDoc) return;
      const renderPage = async (pageNum, canvas) => {
        const page = await pdfDoc.getPage(pageNum);
        const ctx = canvas.getContext("2d");
        const scale = 1.5;
        const viewport = page.getViewport({ scale });
        canvas.width = viewport.width;
        canvas.height = viewport.height;
        await page.render({ canvasContext: ctx, viewport }).promise;
      };
      await renderPage(currentPage, leftCanvas);
      await renderPage(currentPage + 1, rightCanvas);
      renderNotesForPage(currentPage);
    }

    leftCanvas.onclick = () => {
      currentPage = Math.max(1, currentPage - 2);
      renderPagePair();
    };
    rightCanvas.onclick = () => {
      currentPage += 2;
      if (currentPage > pdfDoc.numPages) currentPage = 1;
      renderPagePair();
    };

    fileInput.onchange = async e => {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = async () => {
        const pdfData = new Uint8Array(reader.result);
        pdfDoc = await pdfjsLib.getDocument({ data: pdfData }).promise;
        currentPage = 1;
        renderPagePair();
      };
      reader.readAsArrayBuffer(file);
    };
  </script>
</body>
</html>
